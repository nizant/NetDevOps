---
- name: Network Automation Dev Environment Setup
  hosts: local
  become: true
  vars_files:
    - vars/main.yml

  tasks:
    # ──────────────────────────────────────────────
    # System Packages
    # ──────────────────────────────────────────────
    - name: Update apt cache
      apt:
        update_cache: true
        cache_valid_time: 3600

    - name: Enable multiverse repository (for snmp-mibs-downloader)
      apt_repository:
        repo: "deb http://archive.ubuntu.com/ubuntu {{ ansible_distribution_release }} multiverse"
        state: present
      when: ansible_distribution == 'Ubuntu'

    - name: Install system packages
      apt:
        name: "{{ system_packages }}"
        state: present

    - name: Enable non-free SNMP MIBs
      lineinfile:
        path: /etc/snmp/snmp.conf
        regexp: '^mibs\s*:'
        line: "# mibs :"
        backup: true
      ignore_errors: true

    # ──────────────────────────────────────────────
    # Project Directory Structure
    # ──────────────────────────────────────────────
    - name: Create project directories
      file:
        path: "{{ item }}"
        state: directory
        owner: "{{ ansible_env.SUDO_USER | default(ansible_env.USER) }}"
        mode: "0755"
      loop: "{{ project_dirs }}"

    # ──────────────────────────────────────────────
    # Python Virtual Environment & Libraries
    # ──────────────────────────────────────────────
    - name: Create Python virtual environment
      command: python3 -m venv {{ venv_path }}
      args:
        creates: "{{ venv_path }}/bin/activate"
      become_user: "{{ ansible_env.SUDO_USER | default(ansible_env.USER) }}"
      become: true

    - name: Upgrade pip in virtual environment
      pip:
        name:
          - pip
          - setuptools
          - wheel
        state: latest
        virtualenv: "{{ venv_path }}"
      become_user: "{{ ansible_env.SUDO_USER | default(ansible_env.USER) }}"
      become: true

    - name: Install Python networking libraries
      pip:
        name: "{{ python_packages }}"
        state: present
        virtualenv: "{{ venv_path }}"
      become_user: "{{ ansible_env.SUDO_USER | default(ansible_env.USER) }}"
      become: true

    # ──────────────────────────────────────────────
    # Ansible Collections
    # ──────────────────────────────────────────────
    - name: Install Ansible Galaxy collections
      command: ansible-galaxy collection install {{ item }} --force
      loop: "{{ ansible_collections }}"
      become_user: "{{ ansible_env.SUDO_USER | default(ansible_env.USER) }}"
      become: true
      register: collection_result
      changed_when: "'was installed' in collection_result.stdout"

    # ──────────────────────────────────────────────
    # SSH Configuration
    # ──────────────────────────────────────────────
    - name: Ensure .ssh directory exists
      file:
        path: "/home/{{ ansible_env.SUDO_USER | default(ansible_env.USER) }}/.ssh"
        state: directory
        owner: "{{ ansible_env.SUDO_USER | default(ansible_env.USER) }}"
        mode: "0700"

    - name: Configure SSH for network devices
      copy:
        content: "{{ ssh_config_entries }}"
        dest: "/home/{{ ansible_env.SUDO_USER | default(ansible_env.USER) }}/.ssh/config"
        owner: "{{ ansible_env.SUDO_USER | default(ansible_env.USER) }}"
        mode: "0600"
        backup: true

    # ──────────────────────────────────────────────
    # Git Configuration
    # ──────────────────────────────────────────────
    - name: Configure Git username
      git_config:
        name: user.name
        value: "{{ git_user_name }}"
        scope: global
      become_user: "{{ ansible_env.SUDO_USER | default(ansible_env.USER) }}"
      become: true

    - name: Configure Git email
      git_config:
        name: user.email
        value: "{{ git_user_email }}"
        scope: global
      become_user: "{{ ansible_env.SUDO_USER | default(ansible_env.USER) }}"
      become: true

    # ──────────────────────────────────────────────
    # Shell Convenience
    # ──────────────────────────────────────────────
    - name: Add venv activation alias to .bashrc
      lineinfile:
        path: "/home/{{ ansible_env.SUDO_USER | default(ansible_env.USER) }}/.bashrc"
        line: "{{ item }}"
        create: true
      loop:
        - ""
        - "# Network Automation Environment"
        - "alias netenv='source {{ venv_path }}/bin/activate'"
        - "alias netdir='cd {{ project_base }}'"
      become_user: "{{ ansible_env.SUDO_USER | default(ansible_env.USER) }}"
      become: true

    # ──────────────────────────────────────────────
    # Starter ansible.cfg
    # ──────────────────────────────────────────────
    - name: Create starter ansible.cfg
      copy:
        content: |
          [defaults]
          inventory = ./inventories/hosts
          host_key_checking = False
          timeout = 30
          forks = 10
          stdout_callback = yaml
          retry_files_enabled = False

          [persistent_connection]
          connect_timeout = 60
          command_timeout = 60

          [privilege_escalation]
          become = False
        dest: "{{ project_base }}/ansible.cfg"
        owner: "{{ ansible_env.SUDO_USER | default(ansible_env.USER) }}"
        mode: "0644"
        force: false

    # ──────────────────────────────────────────────
    # Starter Inventory
    # ──────────────────────────────────────────────
    - name: Create starter inventory file
      copy:
        content: |
          [routers]
          # router1 ansible_host=192.168.1.1

          [switches]
          # switch1 ansible_host=192.168.1.2

          [firewalls]
          # fw1 ansible_host=192.168.1.3

          [network:children]
          routers
          switches
          firewalls

          [network:vars]
          ansible_network_os=cisco.ios.ios
          ansible_connection=ansible.netcommon.network_cli
          ansible_user=admin
          # ansible_password=changeme
        dest: "{{ project_base }}/inventories/hosts"
        owner: "{{ ansible_env.SUDO_USER | default(ansible_env.USER) }}"
        mode: "0644"
        force: false

    # ──────────────────────────────────────────────
    # Summary
    # ──────────────────────────────────────────────
    - name: Print setup summary
      debug:
        msg:
          - "=========================================="
          - " Dev environment setup complete!"
          - "=========================================="
          - ""
          - "Project directory: {{ project_base }}"
          - "Python venv:      {{ venv_path }}"
          - ""
          - "Quick start:"
          - "  netenv   → activate the Python venv"
          - "  netdir   → cd to project directory"
          - ""
          - "Next steps:"
          - "  1. Edit vars/main.yml to set your git name/email"
          - "  2. Run 'netenv' to activate the virtual environment"
          - "  3. Add your devices to ~/network-automation/inventories/hosts"
          - "  4. Start writing playbooks in ~/network-automation/playbooks/"
